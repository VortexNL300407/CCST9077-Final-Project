<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quantum Cryptography - Game</title>
    <link rel="stylesheet" href="style.css" id="theme-stylesheet">
    <style>
      /* Add background image styling */
      body {
        position: relative;
        background-image: url('media/game3.jpeg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        overflow-x: hidden;
      }
      
      /* Add overlay to improve text readability */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 15, 30, 0.88);
        z-index: -1;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Quantum Cryptography</h1>
      <p><em>Cryptography of the future</em></p>
      <nav>
        <a href="index.html">Home</a>
        <a href="game.html">Game</a>
        <a href="materials.html">Materials</a>
      </nav>
    </header>

    <main class="page">
      <section class="card">
        <h2>Level 3 - The BB84 Protocol: With Inside Information</h2>
        <p>Now you have a measurement list. Can you eavesdrop without being detected?</p>
        
        <div id="game-container">
          <!-- Title Screen -->
          <div id="title-screen" class="card" style="text-align: center; padding: 1.5rem;">
            <h2>Welcome ‚Äî  BB84 with Inside Information</h2>
            <p style="color: #dbe7ff; font-size: 1rem; max-width: 45rem; margin: 0.5rem auto 1rem;">
              My first eavesdropping attempt failed‚ÄîAlice and Bob detected the quantum disturbances I caused. But I've managed to plant a tracker in Alice's device that records her measurement bases in real-time. Now I can intercept their particles using exactly the same bases she uses, without causing any detectable anomalies. This time, I'll succeed!
            </p>
            <p style="font-size: 0.95rem; color: #dbe7ff; margin-bottom: 1rem;">When you're ready, press Start to begin.</p>
            <button id="start-level" class="btn">Start Level</button>
          </div>

          <!-- Main Game Interface (hidden until Start) -->
          <div id="game-main" class="game-interface" style="display:none;">
            
            <!-- Instructions -->
            <div id="instructions" class="instructions-box">
              <h3 id="instruction-title">Phase 1: Perfect Interception</h3>
              <p id="instruction-text">With the measurement bases from your tracker, measure each unopened particle using the EXACT basis Alice used. This will let you intercept the correct values without detection!</p>
            </div>
            
            <!-- Alice's Reference List -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(87, 172, 246, 0.15); border-radius: 8px; border-left: 3px solid #57acf6;">
              <h4 style="margin-top: 0; color: #57acf6;">Alice's Measurements (Reference)</h4>
              <div id="alice-reference" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8rem; font-family: monospace; font-size: 0.95rem;"></div>
            </div>

            <!-- Two-column layout -->
            <div class="game-columns">
              
              <!-- Left Column: Particle Interception & Basis Comparison & Fake Bits -->
              <div class="left-column">
                <div id="particle-display" class="particle-grid">
                  <!-- Particles will be generated here -->
                </div>

                <div id="fake-bits-display" class="particle-grid" style="display:none;">
                  <!-- Fake bits for Bob will be generated here -->
                </div>

                <div id="basis-comparison" class="basis-grid" style="display:none;">
                  <!-- Basis comparison will appear here -->
                </div>
              </div>

              <!-- Right Column: Info & Key Input -->
              <div class="right-column">
                <div id="phase-info" class="info-box">
                  <h4>Status</h4>
                  <p id="status-text">Particles measured: <strong id="particle-count">0/10</strong></p>
                  <p style="font-size: 0.9rem; color: #dbe7ff; margin-top: 1rem;"><strong>Left Click</strong> to set 90¬∞ (‚îÉ) | <strong>Right Click</strong> to set 45¬∞ (‚ï±)</p>
                  <div style="margin-top: 1rem; padding: 0.8rem; background: rgba(87, 172, 246, 0.2); border-left: 3px solid #57acf6; border-radius: 4px; font-size: 0.9rem; color: #dbe7ff;">
                    <strong>üìù Remember:</strong> List down how Alice measured each bit! We'll need them for later.
                  </div>
                </div>

                <div id="fake-bits-section" style="display:none; margin-top: 1.5rem;">
                  <h4>Send Fake Measurements to Bob</h4>
                  <p style="font-size: 0.9rem; color: #dbe7ff;"><strong>Left Click</strong> to set 90¬∞ (‚îÉ) </br> <strong>Right Click</strong> to set 45¬∞ (‚ï±)</p>
                  <p style="font-size: 0.85rem; color: #aaa; margin-top: 0.5rem;">Make sure to send the measurements matching what you intercepted from Alice!</p>
                  <div style="margin-top: 1rem; padding: 0.8rem; background: rgba(87, 172, 246, 0.2); border-left: 3px solid #57acf6; border-radius: 4px; font-size: 0.9rem; color: #dbe7ff;">
                    <strong>üìù Remember:</strong> Write down the value of each bit. We'll need them to construct the key in the final step!
                  </div>
                  <button id="submit-fake-bits" class="btn" style="margin-top: 1rem;">Submit Fake Bits</button>
                  <div id="fake-bits-feedback"></div>
                </div>

                <div id="key-section" style="display:none; margin-top: 1.5rem;">
                  <h4>Enter the Secret Key</h4>
                  <p style="font-size: 0.9rem; color: #dbe7ff;">Based on the particles you intercepted and the basis comparison, determine the secret key that Alice and Bob share. Enter it as a binary string:</p>
                  <input id="key-input" type="text" placeholder="e.g., 10110101" style="width:100%; padding:0.8rem; font-size:1.1rem; margin:1rem 0; font-family:monospace; letter-spacing:2px;">
                  <button id="submit-key" class="btn">Submit Key</button>
                  <div id="key-feedback"></div>
                </div>
              </div>

            </div>

            <!-- Control Buttons -->
            <div id="control-buttons" style="margin-top: 1.5rem; text-align: center;">
              <button id="submit-phase1" class="btn">Submit Measurements</button>
              <button id="submit-phase1-half" class="btn" style="display:none;">Continue to Basis Comparison</button>
              <button id="restart-level" class="btn btn-outline" style="display:none; margin-left: 0.5rem;">Restart Level</button>
            </div>

            <!-- Victory Screen -->
            <div id="victory-screen" style="display:none; text-align: center;">
              <h3 style="color: #7ef27e; font-size: 2rem;">üéâ Success!</h3>
              <p style="color: #7ef27e; font-size: 1.1rem;">You've successfully eavesdropped on the BB84 key exchange!</p>
              <button id="reset-game" class="btn" style="margin-top: 1rem;">Play Again</button>
            </div>
          </div>

        </div>
      </section>
    </main>

    <footer>
      CCST9077 | Developers: Wong Tsz Yau Martin, Tse Wing Kei, Nathan Lie, Carl Heinrich Ong
    </footer>

    <!-- Audio element for background music -->
    <audio id="bgm" loop>
      <source src="media/bgm.mp3" type="audio/mpeg">
    </audio>

    <div id="settings-btn">‚öôÔ∏è</div>
    <div id="settings-menu">
      <div id="mute-option" class="option">Mute Music</div>
      <div id="theme-option" class="option">üîÑ Larger Fonts (Accessibility)</div>
    </div>
    <div id="info-container">
      <div id="info-icon">‚Ñπ</div>
      <div id="info-popup">This project is an informative and educational website designed to make information on quantum cryptography accessible to a wider audience.</div>
    </div>

  <!-- END BACKGROUND MUSIC SYSTEM -->
  </body>

  <!-- PARALLAX EFFECT SCRIPT -->
  <script>
    (function(){
      const body = document.body;
      if(!body) return;
      
      // Set initial background position to 0
      body.style.backgroundPositionY = '0px';
      
      let ticking = false;
      
      function updateParallax() {
        const scrolled = window.pageYOffset;
        const parallaxSpeed = -0.05;
        
        body.style.backgroundPositionY = `${scrolled * parallaxSpeed}px`;
        
        ticking = false;
      }
      
      function requestTick() {
        if (!ticking) {
          window.requestAnimationFrame(updateParallax);
          ticking = true;
        }
      }
      
      window.addEventListener('scroll', requestTick, { passive: true });
    })();
  </script>
  <!-- END PARALLAX EFFECT SCRIPT -->

  <!-- THEME SWITCHER SCRIPT -->
  <script>
    (function(){
      const themeOption = document.getElementById('theme-option');
      const themeSheet = document.getElementById('theme-stylesheet');
      if(!themeOption || !themeSheet) return;

      let useAccessibleTheme = localStorage.getItem('useAccessibleTheme') === 'true';
      
      function applyTheme(accessible) {
        if(accessible) {
          themeSheet.href = 'styl2.css';
          themeOption.textContent = 'üîÑ Standard Fonts';
          localStorage.setItem('useAccessibleTheme', 'true');
        } else {
          themeSheet.href = 'style.css';
          themeOption.textContent = 'üîÑ Larger Fonts (Accessibility)';
          localStorage.setItem('useAccessibleTheme', 'false');
        }
      }

      applyTheme(useAccessibleTheme);

      themeOption.addEventListener('click', ()=>{
        useAccessibleTheme = !useAccessibleTheme;
        applyTheme(useAccessibleTheme);
      });
    })();
  </script>
  <!-- END THEME SWITCHER SCRIPT -->

  <!-- BB84 Protocol Game Logic -->
  <script>
    class BB84Game {
      constructor() {
        this.numParticles = 10;
        this.aliceBases = []; // Alice's measurement bases (0=90deg, 1=45deg)
        this.aliceValues = []; // The actual qubit values (0 or 1)
        this.eveMeasurements = []; // Eve's guessed values from Phase 1
        this.eveSentBases = []; // Eve's sent bases to Bob
        this.bobBases = []; // Bob's measurement bases
        this.correctKey = []; // The final shared secret key
        this.phase = 1; // Current phase (1: interception, 1.5: send fake bits, 2: basis comparison, 3: key input)
        this.generateData();
      }

      generateData() {
        // Generate random data for Alice
        this.aliceBases = Array.from({length: this.numParticles}, () => Math.random() < 0.5 ? 0 : 1);
        this.aliceValues = Array.from({length: this.numParticles}, () => Math.random() < 0.5 ? 0 : 1);
        
        // Generate random bases for Bob
        this.bobBases = Array.from({length: this.numParticles}, () => Math.random() < 0.5 ? 0 : 1);
        
        // Calculate correct key (only where Alice and Bob bases match)
        this.correctKey = [];
        for(let i = 0; i < this.numParticles; i++) {
          if(this.aliceBases[i] === this.bobBases[i]) {
            this.correctKey.push(this.aliceValues[i]);
          }
        }
      }

      reset() {
        this.generateData();
        this.eveMeasurements = [];
        this.eveSentBases = [];
        this.phase = 1;
      }
    }

    const game = new BB84Game();

    // Track Eve's chosen bases for Phase 1
    let eveChosenBases = [];

    // Phase 1: Display unopened bits and let Eve choose measurement bases
    function renderPhase1() {
      const container = document.getElementById('particle-display');
      const refContainer = document.getElementById('alice-reference');
      container.innerHTML = '';
      refContainer.innerHTML = '';
      
      // Initialize Eve's chosen bases with random values
      eveChosenBases = Array.from({length: game.numParticles}, () => Math.random() < 0.5 ? 0 : 1);
      game.eveMeasurements = [];

      // Display Alice's reference measurements
      for(let i = 0; i < game.numParticles; i++) {
        const refItem = document.createElement('div');
        refItem.style.cssText = 'padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; text-align: center;';
        refItem.innerHTML = `<strong>P${i + 1}:</strong> ${game.aliceBases[i] === 0 ? '‚îÉ 90¬∞' : '‚ï± 45¬∞'}`;
        refContainer.appendChild(refItem);
      }

      // Display unopened bits
      for(let i = 0; i < game.numParticles; i++) {
        const card = document.createElement('div');
        card.className = 'particle-card';
        card.dataset.index = i;
        card.innerHTML = `
          <div class="particle-number">Bit ${i + 1}</div>
          <div class=\"particle-basis\" style=\"color: #888; font-size: 1.2rem; height: 1.5rem; display: flex; align-items: center; justify-content: center;\">?</div>
          <div style="font-size: 0.7rem; color: #888; margin-bottom: 0.3rem; height: 1rem; display: flex; align-items: center; justify-content: center;">Unopened</div>
          <div class="particle-value" style="color: #888; font-weight: bold; font-size: 1.2rem;">?</div>
        `;
        card.style.cursor = 'pointer';
        card.addEventListener('click', (e) => selectPhase1Basis(i, 0));
        card.addEventListener('contextmenu', (e) => { e.preventDefault(); selectPhase1Basis(i, 1); });
        container.appendChild(card);
      }
      
      updateStatus();
    }

    function selectPhase1Basis(index, basis) {
      eveChosenBases[index] = basis;
      const card = document.querySelector(`[data-index="${index}"]`);
      
      if(card) {
        const basisEl = card.querySelector('.particle-basis');
        const degEl = basisEl.nextElementSibling;
        const valueEl = card.querySelector('.particle-value');
        
        basisEl.textContent = basis === 0 ? '‚îÉ' : '‚ï±';
        degEl.textContent = basis === 0 ? '90¬∞' : '45¬∞';
        degEl.style.color = '#dbe7ff';
        valueEl.textContent = '?';
        valueEl.style.color = '#888';
        
        // Check if this basis matches Alice's
        if(basis === game.aliceBases[index]) {
          card.classList.add('selected');
          if(!game.eveMeasurements.includes(index)) {
            game.eveMeasurements.push(index);
          }
        } else {
          card.classList.remove('selected');
          game.eveMeasurements = game.eveMeasurements.filter(i => i !== index);
        }
      }
      
      updateStatus();
    }

    function toggleMeasurement(index) {
      // Kept for compatibility
    }

    function updateStatus() {
      document.getElementById('particle-count').textContent = `${game.eveMeasurements.length}/${game.numParticles}`;
    }

    function renderFakeBits() {
      const container = document.getElementById('fake-bits-display');
      container.innerHTML = '';

      for(let i = 0; i < game.numParticles; i++) {
        const card = document.createElement('div');
        card.className = 'particle-card';
        card.innerHTML = `
          <div class="particle-number">Particle ${i + 1}</div>
          <div class="particle-basis">${game.aliceBases[i] === 0 ? '‚îÉ' : '‚ï±'}</div>
          <div style="font-size: 0.7rem; color: #888; margin-bottom: 0.3rem;">${game.aliceBases[i] === 0 ? '90¬∞' : '45¬∞'}</div>
          <div class="particle-value">${game.aliceValues[i]}</div>
        `;
        container.appendChild(card);
      }
    }

    function renderFakeBits() {
      const container = document.getElementById('fake-bits-display');
      container.innerHTML = '';
      // Start with random bases, not Alice's bases
      game.eveSentBases = Array.from({length: game.numParticles}, () => Math.random() < 0.5 ? 0 : 1);

      for(let i = 0; i < game.numParticles; i++) {
        const card = document.createElement('div');
        card.className = 'particle-card';
        card.dataset.index = i;
        card.innerHTML = `
          <div class="particle-number">Particle ${i + 1}</div>
          <div class="particle-basis">${game.eveSentBases[i] === 0 ? '‚îÉ' : '‚ï±'}</div>
          <div style="font-size: 0.7rem; color: #888; margin-bottom: 0.3rem;">${game.eveSentBases[i] === 0 ? '90¬∞' : '45¬∞'}</div>
          <div class="particle-value">${game.aliceValues[i]}</div>
        `;
        card.style.cursor = 'pointer';
        card.addEventListener('click', (e) => setFakeBasis(i, 0));
        card.addEventListener('contextmenu', (e) => { e.preventDefault(); setFakeBasis(i, 1); });
        container.appendChild(card);
      }
    }

    function setFakeBasis(index, basis) {
      game.eveSentBases[index] = basis;
      const card = document.querySelector(`#fake-bits-display [data-index="${index}"]`);
      if(card) {
        const basisEl = card.querySelector('.particle-basis');
        const degEl = basisEl.nextElementSibling;
        basisEl.textContent = basis === 0 ? '‚îÉ' : '‚ï±';
        if(degEl) {
          degEl.textContent = basis === 0 ? '90¬∞' : '45¬∞';
        }
      }
    }

    document.getElementById('submit-phase1').addEventListener('click', () => {
      // Check if Eve has measured all particles
      if(game.eveMeasurements.length !== game.numParticles) {
        alert('You must measure all particles first!');
        return;
      }

      // Move to phase 1.5 (send fake bits)
      game.phase = 1.5;
      document.getElementById('submit-phase1').style.display = 'none';
      document.getElementById('particle-display').style.display = 'none';
      document.getElementById('alice-reference').parentElement.style.display = 'none';
      document.getElementById('fake-bits-display').style.display = 'grid';
      document.getElementById('phase-info').style.display = 'none';
      document.getElementById('fake-bits-section').style.display = 'block';
      document.getElementById('restart-level').style.display = 'inline-block';
      
      document.getElementById('instruction-title').textContent = 'Phase 1.5: Send Fake Bits to Bob';
      document.getElementById('instruction-text').textContent = 'Now, send fake quantum particles to Bob using the same measurement bases and bit values that you measured from Alice. We have to make sure that we send Bob particles measured in the same way we did to escape detection. Click each particle to toggle its measurement basis:';
      
      renderFakeBits();
      
      renderFakeBits();
    });

    document.getElementById('submit-fake-bits').addEventListener('click', () => {
      const feedback = document.getElementById('fake-bits-feedback');

      // Ensure eveSentBases is properly set
      if(!game.eveSentBases || game.eveSentBases.length === 0) {
        game.eveSentBases = Array.from(game.aliceBases);
      }

      // Check if selections match what was intercepted
      let allCorrect = true;
      for(let i = 0; i < game.numParticles; i++) {
        console.log(`Particle ${i}: eveSent=${game.eveSentBases[i]}, alice=${game.aliceBases[i]}`);
        if(game.eveSentBases[i] !== game.aliceBases[i]) {
          allCorrect = false;
          break;
        }
      }

      if(!allCorrect) {
        // record that the player made a mistake preparing fake bits and immediately end the run
        try {
          localStorage.setItem('level3_mistake', 'true');
          localStorage.setItem('level3_key_correct', 'false');
          localStorage.setItem('level3_completed', 'false');
        } catch(e){}
        feedback.innerHTML = '<p style="color: #ff9a9a;">Incorrect! Your basis selections don\'t match what you intercepted from Alice.</p>';
        // show feedback briefly, then navigate to the ending page so outcome is determined now
        setTimeout(() => { window.location.href = 'ending.html'; }, 800);
        return;
      }

      feedback.innerHTML = '<p style="color: #7ef27e;">‚úì Correct! You successfully sent fake bits to Bob!</p>';
      
      setTimeout(() => {
        // Move to phase 2
        game.phase = 2;
        document.getElementById('submit-phase1-half').style.display = 'none';
        document.getElementById('restart-level').style.display = 'inline-block';
        document.getElementById('fake-bits-display').style.display = 'none';
        document.getElementById('fake-bits-section').style.display = 'none';
        document.getElementById('basis-comparison').style.display = 'grid';
        document.getElementById('key-section').style.display = 'block';
        
        document.getElementById('instruction-title').textContent = 'Phase 2: Compare Measurement Bases';
        document.getElementById('instruction-text').textContent = 'Alice and Bob have publicly announced their measurement bases (but NOT their results). Below you can see which particles had matching bases. Only particles where you used the SAME basis as Alice will give you correct key bits.';
        
        renderPhase2();
      }, 700);
    });

    document.getElementById('submit-phase1-half').addEventListener('click', () => {
      // Move to phase 2
      game.phase = 2;
      document.getElementById('submit-phase1-half').style.display = 'none';
      document.getElementById('restart-level').style.display = 'inline-block';
      document.getElementById('fake-bits-display').style.display = 'none';
      document.getElementById('basis-comparison').style.display = 'grid';
      document.getElementById('key-section').style.display = 'block';
      
      document.getElementById('instruction-title').textContent = 'Phase 2: Compare Measurement Bases';
      document.getElementById('instruction-text').textContent = 'Alice and Bob have publicly announced their measurement bases (but NOT their results). Below you can see which particles had matching bases. Only particles where you used the SAME basis as Alice will give you correct key bits.';
      
      renderPhase2();
    });



    // Phase 2: Compare bases
    function renderPhase2() {
      const container = document.getElementById('basis-comparison');
      container.innerHTML = '';

      for(let i = 0; i < game.numParticles; i++) {
        const row = document.createElement('div');
        const basesMatch = game.aliceBases[i] === game.bobBases[i];
        
        row.className = 'basis-card ' + (basesMatch ? 'match' : 'mismatch');
        row.innerHTML = `
          <div style="font-size: 0.7rem; color: #888; margin-bottom: 0.5rem;">Particle ${i + 1}</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
            <div><span style="color: #888; font-size: 0.65rem;">Alice:</span><br><strong>${game.aliceBases[i] === 0 ? '‚îÉ' : '‚ï±'}</strong></div>
            <div><span style="color: #888; font-size: 0.65rem;">Bob:</span><br><strong>${game.bobBases[i] === 0 ? '‚îÉ' : '‚ï±'}</strong></div>
          </div>
          <div style="padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 0.75rem; font-weight: bold;">
            ${basesMatch ? '<span style="color: #7ef27e;">‚úì Match</span>' : '<span style="color: #ff9a9a;">‚úó Mismatch</span>'}
          </div>
        `;
        container.appendChild(row);
      }
    }

    document.getElementById('restart-level').addEventListener('click', () => {
      game.reset();
      document.getElementById('game-main').style.display = 'block';
      document.getElementById('victory-screen').style.display = 'none';
      document.getElementById('submit-phase1').style.display = 'inline-block';
      document.getElementById('submit-phase1-half').style.display = 'none';
      document.getElementById('restart-level').style.display = 'none';
      document.getElementById('particle-display').style.display = 'grid';
      document.getElementById('alice-reference').parentElement.style.display = 'block';
      document.getElementById('phase-info').style.display = 'block';
      document.getElementById('fake-bits-display').style.display = 'none';
      document.getElementById('fake-bits-section').style.display = 'none';
      document.getElementById('basis-comparison').style.display = 'none';
      document.getElementById('key-section').style.display = 'none';
      document.getElementById('key-feedback').innerHTML = '';
      document.getElementById('key-input').value = '';
      document.getElementById('fake-bits-feedback').innerHTML = '';
      
      document.getElementById('instruction-title').textContent = 'Phase 1: Intercept the Quantum Particles';
      document.getElementById('instruction-text').textContent = 'Alice is sending quantum particles to Bob using random measurement bases (90¬∞ or 45¬∞). You know which basis she\'s using for each particle. Click each particle to measure it and intercept the value!';
      
      renderPhase1();
    });

    // Phase 3: Submit the key
    document.getElementById('submit-key').addEventListener('click', () => {
      const userKey = document.getElementById('key-input').value.replace(/[^01]/g, '');
      const correctKeyStr = game.correctKey.join('');
      const feedback = document.getElementById('key-feedback');

      if(userKey === '' || userKey.length === 0) {
        feedback.innerHTML = '<p style="color: #ff9a9a;">Enter the key!</p>';
        return;
      }

      if(userKey === correctKeyStr) {
        feedback.innerHTML = '<p style="color: #7ef27e;">‚úì Correct key!</p>';
        // mark completed and go to ending page
        try { localStorage.setItem('level3_key_correct', 'true'); localStorage.setItem('level3_completed','true'); } catch(e){}
        setTimeout(() => {
          // go to ending page which will decide Good/Bad based on 'level3_mistake'
          window.location.href = 'ending.html';
        }, 500);
      } else {
        // record that player submitted a wrong key at least once and end the run
        try {
          localStorage.setItem('level3_key_correct', 'false');
          localStorage.setItem('level3_mistake', 'true');
          localStorage.setItem('level3_completed', 'false');
        } catch(e){}
        feedback.innerHTML = `<p style="color: #ff9a9a;">‚úó Incorrect. Redirecting to ending...</p>`;
        // give user a moment to see feedback, then go to ending page (Bad ending)
        setTimeout(() => { window.location.href = 'ending.html'; }, 800);
      }
    });

    document.getElementById('reset-game').addEventListener('click', () => {
      game.reset();
      document.getElementById('game-main').style.display = 'block';
      document.getElementById('victory-screen').style.display = 'none';
      document.getElementById('submit-phase1').style.display = 'inline-block';
      document.getElementById('submit-phase1-half').style.display = 'none';
      document.getElementById('restart-level').style.display = 'none';
      document.getElementById('particle-display').style.display = 'grid';
      document.getElementById('alice-reference').parentElement.style.display = 'block';
      document.getElementById('phase-info').style.display = 'block';
      document.getElementById('fake-bits-display').style.display = 'none';
      document.getElementById('fake-bits-section').style.display = 'none';
      document.getElementById('basis-comparison').style.display = 'none';
      document.getElementById('key-section').style.display = 'none';
      document.getElementById('key-feedback').innerHTML = '';
      document.getElementById('key-input').value = '';
      document.getElementById('fake-bits-feedback').innerHTML = '';
      
      document.getElementById('instruction-title').textContent = 'Phase 1: Intercept the Quantum Particles';
      document.getElementById('instruction-text').textContent = 'Alice is sending quantum particles to Bob using random measurement bases (90¬∞ or 45¬∞). You know which basis she\'s using for each particle. Click each particle to measure it and intercept the value!';
      
      renderPhase1();
    });

    // Initialize page on load: show title screen first
    document.addEventListener('DOMContentLoaded', () => {
      const title = document.getElementById('title-screen');
      const main = document.getElementById('game-main');
      if(title) title.style.display = 'block';
      if(main) main.style.display = 'none';

      const startBtn = document.getElementById('start-level');
      if(startBtn) {
        startBtn.addEventListener('click', () => {
          // reset any previous ending flags for a fresh run
          try { localStorage.removeItem('level3_mistake'); localStorage.removeItem('level3_completed'); } catch(e){}
          title.style.display = 'none';
          main.style.display = 'block';
          renderPhase1();
        });
      }
    });

    // Levels sidebar functionality
    (function(){
      const tab = document.getElementById('levels-tab');
      const sidebar = document.getElementById('levels-sidebar');
      const closeBtn = document.getElementById('levels-close');
      if(tab && sidebar){
        tab.addEventListener('click', ()=>{ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); });
        closeBtn.addEventListener('click', ()=>{ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); });
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); } });
      }
    })();
  </script>

  <!-- Audio element for background music -->
  <audio id="bgm" loop>
    <source src="media/bgm.mp3" type="audio/mpeg">
  </audio>

  <!-- BACKGROUND MUSIC SYSTEM -->
  <script>
    (function(){
      const bgm = document.getElementById('bgm');
      if(!bgm) return;
      const btn = document.getElementById('settings-btn');
      const menu = document.getElementById('settings-menu');
      const muteOption = document.getElementById('mute-option');
      let menuOpen = false;

      let savedMuted = localStorage.getItem('musicMuted') === 'true';
      let savedTime = parseFloat(localStorage.getItem('musicTime')) || 0;
      bgm.muted = savedMuted;
      bgm.currentTime = savedTime;

      window.addEventListener('click', ()=>{ bgm.play().catch(()=>{}); bgm.volume = 0.2; }, { once: true });
      bgm.volume = 0.2; bgm.play().catch(()=>{});

      setInterval(()=>{ localStorage.setItem('musicTime', bgm.currentTime); }, 1000);

      btn.onclick = ()=>{ menuOpen = !menuOpen; menu.style.display = menuOpen ? 'block' : 'none'; };
      muteOption.onclick = ()=>{ bgm.muted = !bgm.muted; localStorage.setItem('musicMuted', bgm.muted); muteOption.textContent = bgm.muted ? 'Unmute Music' : 'Mute Music'; };
      muteOption.textContent = bgm.muted ? 'Unmute Music' : 'Mute Music';
    })();
  </script>
  <!-- END BACKGROUND MUSIC SYSTEM -->

  <!-- THEME SWITCHER SCRIPT -->
  <script>
    (function(){
      const themeOption = document.getElementById('theme-option');
      const themeSheet = document.getElementById('theme-stylesheet');
      if(!themeOption || !themeSheet) return;

      let useAccessibleTheme = localStorage.getItem('useAccessibleTheme') === 'true';
      
      function applyTheme(accessible) {
        if(accessible) {
          themeSheet.href = 'styl2.css';
          themeOption.textContent = 'üîÑ Standard Fonts';
          localStorage.setItem('useAccessibleTheme', 'true');
        } else {
          themeSheet.href = 'style.css';
          themeOption.textContent = 'üîÑ Larger Fonts (Accessibility)';
          localStorage.setItem('useAccessibleTheme', 'false');
        }
      }

      applyTheme(useAccessibleTheme);

      themeOption.addEventListener('click', ()=>{
        useAccessibleTheme = !useAccessibleTheme;
        applyTheme(useAccessibleTheme);
      });
    })();
  </script>
  <!-- END THEME SWITCHER SCRIPT -->

  <!-- Levels slide-out tab -->
  <div id="levels-tab" title="Open levels">Levels</div>
  <aside id="levels-sidebar" aria-hidden="true">
    <button id="levels-close" class="btn btn-outline">Close</button>
    <h3>Levels</h3>
    <ul class="levels-list">
      <li><a href="game.html">Level 1 ‚Äî Caesar's Cipher</a></li>
      <li><a href="level2.html">Level 2 ‚Äî Modern Crypto (MCQ)</a></li>
      <li><a href="level3_materials.html">Level 3 ‚Äî QKD Materials</a></li>
    </ul>
  </aside>

  <!-- BEGIN: Levels sidebar toggle functionality -->
  <script>
    (function(){
      const tab = document.getElementById('levels-tab');
      const sidebar = document.getElementById('levels-sidebar');
      const closeBtn = document.getElementById('levels-close');
      if(tab && sidebar){
        tab.addEventListener('click', ()=>{ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); });
        closeBtn.addEventListener('click', ()=>{ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); });
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); } });
      }
    })();
  </script>
  <!-- END: Levels sidebar toggle functionality -->

  </body>
</html>
