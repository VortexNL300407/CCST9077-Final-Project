<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Level 3 ‚Äî Materials: QKD & BB84</title>
    <link rel="stylesheet" href="style.css" id="theme-stylesheet">
    <style>
      /* Add background image styling */
      body {
        position: relative;
        background-image: url('media/game3.jpeg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        overflow-x: hidden;
      }
      
      /* Add overlay to improve text readability */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 15, 30, 0.88);
        z-index: -1;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Quantum Cryptography</h1>
      <p><em>Cryptography of the future</em></p>
      <nav>
        <a href="index.html">Home</a>
        <a href="game.html">Game</a>
        <a href="materials.html">Materials</a>
      </nav>
    </header>

    <main class="page">
      <section class="card">
        <h2 style="text-align:center; margin-top:0;">Level 3 ‚Äî Challenge : Quantum Key Distribution</h2>
        <p style="text-align:center; max-width:820px; margin:0.6rem auto; color:#d6e6ff;">Oh no! Alice and Bob have upgraded their security to Quantum Cybersecurity!! They're utilizing the BB84 Quantum Key Distribution Protocol. You have to learn how this protocol works if you wish to intercept their love!!</p>

        <div style="max-width:900px; margin:1rem auto; color:#dbe7ff; line-height:1.6;">
          <h3>What is QKD (BB84)?</h3>
          <p>Quantum Key Distribution is a certain protocol created to demonstrate how we can utilize Quantum Superposition and Entanglement properties to create a guranteed secure communication channel. Protocols like the BB84 and E91 Protocols were created in 1984 and 1991 respectively to implement the idea of a secure communication channel with Quantum Superposition and Entanglement.</p>

          <h3>How BB84 Protocol works (high level)</h3>
          <ol>
            <li><strong>Alice</strong> prepares a sequence of qubits</li>
            <li>For each bit, Alice measures it with Horizontal vs Vertical or 45¬∞ vs -45¬∞ measurement and notes down the type of measurement(+ or X) and the values(0 or 1) she gets for each qubit in the sequence</li>
            <li><strong>Alice</strong> Alice sends the sequence of qubits through an insecure communication channel to Bob.</li>
            <li><strong>Bob</strong> measures each incoming qubit using Horizontal vs Vertical or 45¬∞ vs -45¬∞ measurements.</li>
            <li>Afterwhich, both Alice and Bob will announce the measurements they use for each qubit.</li>
            <li>For each qubit, if they happened to have used the same type of measurement, they will keep its value as part of the key they will create.</li>
            <li>If there is a qubit which they measure with the same type of measurement, but yields different values, they will know there is an eavesdropper.</li>
          </ol>

        </div>

        <!-- BB84 interactive simulation -->
        <div id="bb84-sim" style="max-width:900px; margin:1.2rem auto; background:rgba(10,18,30,0.25); padding:1rem; border-radius:6px;">
          <h3 style="text-align:center; margin-top:0;">Interactive BB84 Simulation (5 qubits)</h3>
          <p style="text-align:center; color:#d6e6ff;">Act as Alice and Bob: choose the measurement basis for each qubit, measure, then compare bases to derive the shared key.</p>

          <div style="display:flex; justify-content:center; gap:0.5rem; margin-bottom:0.6rem;">
            <button id="bb84-gen" class="btn">Generate New Sequence</button>
            <button id="alice-measure" class="btn">Alice: Measure All</button>
            <button id="bob-measure" class="btn">Bob: Measure All</button>
            <button id="bb84-reset" class="btn btn-outline">Reset</button>
          </div>

          <div class="bb84-headers" style="display:grid; grid-template-columns:1fr 1fr 1fr; align-items:center; gap:0.6rem; padding:0.2rem 0.4rem; color:#cfe9ff; font-weight:600;">
            <div style="grid-column:1; display:flex; align-items:center; text-align:left">Alice ‚Äî Basis & Value</div>
            <div style="grid-column:2 ; display:flex; align-items:center; justify-content:center;text-align:center">Bob ‚Äî Basis & Value</div>
            <div style="grid-column:3; display:flex; align-items:center; justify-content:center; text-align:center">Result</div>
          </div>

          <div id="bb84-container" style="display:grid; gap:0.6rem; grid-template-columns:1fr;">
            <!-- Per-qubit rows injected here -->
          </div>


          <div id="bb84-result" style="margin-top:0.8rem; text-align:center; color:#d6e6ff;">
            <div id="bb84-matches" style="margin-bottom:0.4rem;"></div>
            <div id="bb84-key" style="font-weight:600; font-family:monospace; background:rgba(255,255,255,0.03); display:inline-block; padding:0.4rem 0.6rem; border-radius:4px;"></div>
          </div>
        </div>

        <div>
          <h3>Why eavesdropping is detectable</h3>
          <p>We must be careful! If we don't know the measurements Alice used, we might disturb the entanglement property of the qubits. If this happens, Alice and Bob can see the high error rate on qubits that they measure with the same type of measurement, prompting them to abort the key.</p>

          <!-- BB84 with Eve simulation (inserted before 'What you'll practice') -->
          <div id="bb84-eve-sim" style="max-width:900px; margin:1.2rem auto; background:rgba(10,18,30,0.18); padding:1rem; border-radius:6px;">
            <h3 style="text-align:center; margin-top:0;">BB84 ‚Äî With Eve (Eavesdropper)</h3>
            <p style="text-align:center; color:#d6e6ff;">Follow Alice ‚Üí Eve ‚Üí Bob. Try letting Eve measure with different bases and observe how that disturbs the key.</p>

            <div style="display:flex; justify-content:center; gap:0.5rem; margin-bottom:0.6rem;">
              <button id="bb84-e-gen" class="btn">Generate New Sequence</button>
              <button id="alice-e-measure" class="btn">Alice: Measure All</button>
              <button id="eve-measure" class="btn">Eve: Intercept & Measure</button>
              <button id="bob-e-measure" class="btn">Bob: Measure All</button>
              <button id="bb84-e-reset" class="btn btn-outline">Reset</button>
            </div>

            <div class="bb84-headers-e" style="display:grid; grid-template-columns:3ch 1fr 2ch 1fr 2ch 1fr 6ch; align-items:center; gap:0.6rem; padding:0.2rem 0.4rem; color:#cfe9ff; font-weight:600;">
              <div style="grid-column:1"></div>
              <div style="grid-column:2; text-align:left">Alice ‚Äî Basis & Value</div>
              <div style="grid-column:3; text-align:center"></div>
              <div style="grid-column:4; text-align:center">Eve ‚Äî Basis & Value</div>
              <div style="grid-column:5; text-align:center"></div>
              <div style="grid-column:6; text-align:center">Bob ‚Äî Basis & Value</div>
              <div style="grid-column:7; text-align:center">Result</div>
            </div>

            <div id="bb84-e-container" style="display:grid; gap:0.6rem; grid-template-columns:1fr;">
              <!-- rows injected -->
            </div>

            <div id="bb84-e-result" style="margin-top:0.8rem; text-align:center; color:#d6e6ff;">
              <div id="bb84-e-matches" style="margin-bottom:0.4rem;"></div>
              <div id="bb84-e-key" style="font-weight:600; font-family:monospace; background:rgba(255,255,255,0.03); display:inline-block; padding:0.4rem 0.6rem; border-radius:4px;"></div>
            </div>
          </div>

          <h3>What you'll practice in Level 3</h3>
          <ul>
            <li>3.1 ‚Äî You don't know Alice's measurements. See if you can successfully intercept their key.</li>
            <li>3.2 ‚Äî You know Alice's measurements. See if you can successfully intercept their key.</li>
          </ul>

          <p style="margin-top:1rem; font-style:italic; color:#cfdcff;">Key Takeaway : You will see just how robust Quantum Key Cryptography is, along with its weaknesses that we can try to exploit.</p>
        </div>

        <div style="text-align:center; margin-top:1.2rem;">
          <a class="btn" href="level3.html">Proceed to Level 3</a>
        </div>
      </section>
    </main>

    <footer>
      CCST9077 | Members:
    </footer>

    <!-- Levels slide-out tab -->
    <div id="levels-tab" title="Open levels">Levels</div>
    <aside id="levels-sidebar" aria-hidden="true">
      <button id="levels-close" class="btn btn-outline">Close</button>
      <h3>Levels</h3>
      <ul class="levels-list">
        <li><a href="game.html">Level 1 ‚Äî Caesar's Cipher</a></li>
        <li><a href="level2.html">Level 2 ‚Äî Modern Crypto (MCQ)</a></li>
        <li><a href="level3_materials.html">Level 3 ‚Äî QKD Materials</a></li>
      </ul>
    </aside>

    <script>
      (function(){
        const tab = document.getElementById('levels-tab');
        const sidebar = document.getElementById('levels-sidebar');
        const closeBtn = document.getElementById('levels-close');
        if(tab && sidebar){
          tab.addEventListener('click', ()=>{ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); });
          closeBtn.addEventListener('click', ()=>{ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); });
          document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); } });
        }
      })();
    </script>
    <script>
      (function(){
        // Enhanced BB84 5-qubit interactive simulation (modern basis selectors + key label)
        const N = 5;
        let trueBases = [];
        let trueBits = [];
        let aliceBases = Array(N).fill(null);
        let aliceBits = Array(N).fill(null);
        let bobBases = Array(N).fill(null);
        let bobBits = Array(N).fill(null);

        const container = document.getElementById('bb84-container');
        const genBtn = document.getElementById('bb84-gen');
        const aliceBtn = document.getElementById('alice-measure');
        const bobBtn = document.getElementById('bob-measure');
        const resetBtn = document.getElementById('bb84-reset');
        const matchesEl = document.getElementById('bb84-matches');
        const keyEl = document.getElementById('bb84-key');

        function randBit(){ return Math.random() < 0.5 ? 0 : 1; }

        function makeBasisSelector(i, role){
          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex'; wrapper.style.gap = '0.25rem';
          wrapper.className = role === 'alice' ? 'alice-selector' : 'bob-selector';

          ['+','x'].forEach(sym => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'basis-btn';
            btn.textContent = sym;
            btn.dataset.index = i;
            btn.dataset.sym = sym;
            btn.style.padding = '0.28rem 0.5rem';
            btn.style.borderRadius = '6px';
            btn.style.border = '1px solid rgba(255,255,255,0.08)';
            btn.style.background = 'transparent';
            btn.style.color = '#cfe9ff';
            btn.style.minWidth = '2.2rem';
            btn.style.fontWeight = '600';
            btn.onclick = (e)=>{
              const idx = Number(e.currentTarget.dataset.index);
              const s = e.currentTarget.dataset.sym;
              if(role === 'alice'){
                aliceBases[idx] = s; // set chosen basis
                // toggle selected styling for this row's alice buttons
                const rowBtns = e.currentTarget.parentElement.querySelectorAll('.basis-btn');
                rowBtns.forEach(b=> b.style.background = b === e.currentTarget ? 'linear-gradient(90deg,#1b6cff,#3dd0ff)' : 'transparent');
                rowBtns.forEach(b=> b.style.color = b === e.currentTarget ? '#001723' : '#cfe9ff');
              } else {
                bobBases[idx] = s;
                const rowBtns = e.currentTarget.parentElement.querySelectorAll('.basis-btn');
                rowBtns.forEach(b=> b.style.background = b === e.currentTarget ? 'linear-gradient(90deg,#8ef5a1,#27c07a)' : 'transparent');
                rowBtns.forEach(b=> b.style.color = b === e.currentTarget ? '#003216' : '#cfe9ff');
              }
            };
            wrapper.appendChild(btn);
          });

          return wrapper;
        }

        function makeRow(i){
          const row = document.createElement('div');
          row.className = 'bb84-row';
          row.style.display = 'grid';
          row.style.gridTemplateColumns = '3ch 1fr 2ch 1fr 6ch';
          row.style.alignItems = 'center';
          row.style.gap = '0.6rem';
          row.style.padding = '0.4rem';
          row.style.background = 'rgba(255,255,255,0.02)';
          row.style.borderRadius = '6px';

          const idx = document.createElement('div'); idx.textContent = `Q${i+1}`; idx.style.width = '3ch'; idx.style.textAlign = 'center'; idx.style.fontWeight = '600'; idx.style.color = '#dbe7ff';

          const aliceSel = makeBasisSelector(i, 'alice');
          const aliceVal = document.createElement('div'); aliceVal.id = `alice-bit-${i}`; aliceVal.textContent = '‚Äì'; aliceVal.style.minWidth = '2ch'; aliceVal.style.textAlign = 'center'; aliceVal.style.color = '#cfe9ff'; aliceVal.style.fontWeight = '700';

          const arrow = document.createElement('div'); arrow.textContent = '‚Üí'; arrow.style.opacity = 0.8; arrow.style.width = '2ch'; arrow.style.textAlign = 'center'; arrow.style.color = '#cfe9ff';

          const bobSel = makeBasisSelector(i, 'bob');
          const bobVal = document.createElement('div'); bobVal.id = `bob-bit-${i}`; bobVal.textContent = '‚Äì'; bobVal.style.minWidth = '2ch'; bobVal.style.textAlign = 'center'; bobVal.style.color = '#cfe9ff'; bobVal.style.fontWeight = '700';

          const status = document.createElement('div'); status.id = `match-${i}`; status.style.minWidth = '6ch'; status.style.textAlign = 'center'; status.style.fontSize = '0.9rem'; status.style.color = '#cfe9ff';

          const aGroup = document.createElement('div'); aGroup.style.display='flex'; aGroup.style.gap='0.5rem'; aGroup.style.alignItems='center'; aGroup.appendChild(aliceSel); aGroup.appendChild(aliceVal);
          const bGroup = document.createElement('div'); bGroup.style.display='flex'; bGroup.style.gap='0.5rem'; bGroup.style.alignItems='center'; bGroup.appendChild(bobSel); bGroup.appendChild(bobVal);

          // Append five cells matching the header: idx, Alice group, arrow, Bob group, result
          row.appendChild(idx);
          row.appendChild(aGroup);
          row.appendChild(arrow);
          row.appendChild(bGroup);
          row.appendChild(status);

          return row;
        }

        function renderGrid(){
          container.innerHTML = '';
          for(let i=0;i<N;i++) container.appendChild(makeRow(i));
          matchesEl.textContent = '';
          keyEl.textContent = 'Key : ';
        }

        function generateSequence(){
          trueBases = Array.from({length:N}, ()=> Math.random() < 0.5 ? '+' : 'x');
          trueBits = Array.from({length:N}, ()=> randBit());
          aliceBases.fill(null); aliceBits.fill(null); bobBases.fill(null); bobBits.fill(null);
          renderGrid();
        }

        function aliceMeasure(){
          // ensure all alice bases chosen
          for(let i=0;i<N;i++) if(!aliceBases[i]){ alert('Choose a basis for all qubits as Alice before measuring.'); return; }
          for(let i=0;i<N;i++){
            const chosen = aliceBases[i];
            if(chosen === trueBases[i]) aliceBits[i] = trueBits[i];
            else aliceBits[i] = randBit();
            // collapse
            trueBases[i] = chosen; trueBits[i] = aliceBits[i];
            document.getElementById(`alice-bit-${i}`).textContent = aliceBits[i];
            document.getElementById(`match-${i}`).textContent = '';
            document.getElementById(`bob-bit-${i}`).textContent = '‚Äì';
          }
          matchesEl.textContent = 'Alice measured. Now choose Bob bases and measure.';
          keyEl.textContent = 'Key : ';
        }

        function bobMeasure(){
          for(let i=0;i<N;i++) if(!bobBases[i]){ alert('Choose a basis for all qubits as Bob before measuring.'); return; }
          for(let i=0;i<N;i++){
            const chosen = bobBases[i];
            if(chosen === trueBases[i]) bobBits[i] = trueBits[i];
            else bobBits[i] = randBit();
            document.getElementById(`bob-bit-${i}`).textContent = bobBits[i];
            const matchEl = document.getElementById(`match-${i}`);
            if(aliceBases[i] && bobBases[i]){
              if(aliceBases[i] === bobBases[i]){ matchEl.textContent = 'MATCH'; matchEl.style.color = '#9bf59b'; }
              else { matchEl.textContent = 'DIFF'; matchEl.style.color = '#f59b9b'; }
            }
          }
          const keyBits = [];
          const matches = [];
          for(let i=0;i<N;i++){
            if(aliceBases[i] && bobBases[i] && aliceBases[i] === bobBases[i]){ keyBits.push(String(aliceBits[i])); matches.push(i+1); }
          }
          matchesEl.textContent = matches.length ? `Matched positions: ${matches.join(', ')}` : 'No matching bases ‚Äî no key bits kept.';
          keyEl.textContent = keyBits.length ? `Key : ${keyBits.join('')}` : 'Key : (empty)';
        }

        genBtn.addEventListener('click', generateSequence);
        aliceBtn.addEventListener('click', aliceMeasure);
        bobBtn.addEventListener('click', bobMeasure);
        resetBtn.addEventListener('click', ()=>{ generateSequence(); });

        generateSequence();
      })();
    </script>
    <script>
      (function(){
        // BB84 with Eve simulation (5 qubits)
        const N = 5;
        let trueBasesE = [];
        let trueBitsE = [];
        let aliceBasesE = Array(N).fill(null), aliceBitsE = Array(N).fill(null);
        let eveBases = Array(N).fill(null), eveBits = Array(N).fill(null);
        let bobBasesE = Array(N).fill(null), bobBitsE = Array(N).fill(null);

        const cont = document.getElementById('bb84-e-container');
        const gen = document.getElementById('bb84-e-gen');
        const aBtn = document.getElementById('alice-e-measure');
        const eBtn = document.getElementById('eve-measure');
        const bBtn = document.getElementById('bob-e-measure');
        const rBtn = document.getElementById('bb84-e-reset');
        const matchesE = document.getElementById('bb84-e-matches');
        const keyE = document.getElementById('bb84-e-key');

        function randBit(){ return Math.random() < 0.5 ? 0 : 1; }

        function makeSelector(i, role, prefix){
          const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.gap='0.25rem';
          ['+','x'].forEach(sym=>{
            const btn = document.createElement('button'); btn.type='button'; btn.className='basis-btn'; btn.textContent=sym;
            btn.dataset.index = i; btn.dataset.sym = sym;
            btn.onclick = (ev)=>{
              const idx = Number(ev.currentTarget.dataset.index); const s = ev.currentTarget.dataset.sym;
              if(role==='alice') { aliceBasesE[idx]=s; }
              else if(role==='eve') { eveBases[idx]=s; }
              else { bobBasesE[idx]=s; }
              // visual toggle styling
              const rowBtns = ev.currentTarget.parentElement.querySelectorAll('.basis-btn');
              rowBtns.forEach(b=> b.style.background = b===ev.currentTarget ? (role==='alice' ? 'linear-gradient(90deg,#1b6cff,#3dd0ff)' : role==='eve' ? 'linear-gradient(90deg,#f5d36b,#f59b42)' : 'linear-gradient(90deg,#8ef5a1,#27c07a)') : 'transparent');
              rowBtns.forEach(b=> b.style.color = b===ev.currentTarget ? (role==='eve' ? '#2b1a00' : '#001723') : '#cfe9ff');
            };
            wrapper.appendChild(btn);
          });
          return wrapper;
        }

        function makeRow(i){
          const row = document.createElement('div');
          row.style.display='grid';
          row.style.gridTemplateColumns='3ch 1fr 2ch 1fr 2ch 1fr 6ch';
          row.style.alignItems='center';
          row.style.gap='0.6rem';
          row.style.padding='0.4rem';
          row.style.background='rgba(255,255,255,0.01)';
          row.style.borderRadius='6px';

          const idx = document.createElement('div');
          idx.textContent = `Q${i+1}`;
          idx.style.textAlign='center'; idx.style.fontWeight='600'; idx.style.color='#dbe7ff';

          // Alice group (selector + value)
          const aSel = makeSelector(i,'alice');
          const aVal = document.createElement('div');
          aVal.id = `alice-e-bit-${i}`; aVal.textContent='‚Äì'; aVal.style.textAlign='center'; aVal.style.color='#cfe9ff'; aVal.style.fontWeight='700';
          const aGroup = document.createElement('div');
          aGroup.style.display='flex'; aGroup.style.gap='0.5rem'; aGroup.style.alignItems='center';
          aGroup.appendChild(aSel); aGroup.appendChild(aVal);

          // Arrow between Alice and Eve
          const arrow = document.createElement('div'); arrow.textContent='‚Üí'; arrow.style.textAlign='center'; arrow.style.color='#cfe9ff';

          // Eve group (selector + value)
          const eSel = makeSelector(i,'eve');
          const eVal = document.createElement('div'); eVal.id = `eve-bit-${i}`; eVal.textContent='‚Äì'; eVal.style.textAlign='center'; eVal.style.color='#f8e3c2'; eVal.style.fontWeight='700';
          const eGroup = document.createElement('div'); eGroup.style.display='flex'; eGroup.style.gap='0.5rem'; eGroup.style.alignItems='center'; eGroup.appendChild(eSel); eGroup.appendChild(eVal);

          // Arrow between Eve and Bob
          const arrow2 = document.createElement('div'); arrow2.textContent='‚Üí'; arrow2.style.textAlign='center'; arrow2.style.color='#cfe9ff';

          // Bob group (selector + value)
          const bSel = makeSelector(i,'bob');
          const bVal = document.createElement('div'); bVal.id = `bob-e-bit-${i}`; bVal.textContent='‚Äì'; bVal.style.textAlign='center'; bVal.style.color='#cfe9ff'; bVal.style.fontWeight='700';
          const bGroup = document.createElement('div'); bGroup.style.display='flex'; bGroup.style.gap='0.5rem'; bGroup.style.alignItems='center'; bGroup.appendChild(bSel); bGroup.appendChild(bVal);

          const status = document.createElement('div'); status.id = `match-e-${i}`; status.style.textAlign='center'; status.style.fontSize='0.9rem'; status.style.color='#cfe9ff';

          // Append exactly seven cells matching the header grid: idx, Alice group, arrow, Eve group, arrow2, Bob group, result
          row.appendChild(idx);
          row.appendChild(aGroup);
          row.appendChild(arrow);
          row.appendChild(eGroup);
          row.appendChild(arrow2);
          row.appendChild(bGroup);
          row.appendChild(status);

          return row;
        }

        function render(){ cont.innerHTML=''; for(let i=0;i<N;i++) cont.appendChild(makeRow(i)); matchesE.textContent=''; keyE.textContent='Key : '; }

        function generate(){ trueBasesE = Array.from({length:N}, ()=> Math.random() < 0.5 ? '+' : 'x'); trueBitsE = Array.from({length:N}, ()=> randBit()); aliceBasesE.fill(null); aliceBitsE.fill(null); eveBases.fill(null); eveBits.fill(null); bobBasesE.fill(null); bobBitsE.fill(null); render(); }

        function aliceMeasure(){ for(let i=0;i<N;i++) if(!aliceBasesE[i]){ alert('Pick all Alice bases first'); return; } for(let i=0;i<N;i++){ const c=aliceBasesE[i]; if(c===trueBasesE[i]) aliceBitsE[i]=trueBitsE[i]; else aliceBitsE[i]=randBit(); // collapse
            trueBasesE[i]=c; trueBitsE[i]=aliceBitsE[i]; document.getElementById(`alice-e-bit-${i}`).textContent = aliceBitsE[i]; document.getElementById(`eve-bit-${i}`).textContent='‚Äì'; document.getElementById(`bob-e-bit-${i}`).textContent='‚Äì'; document.getElementById(`match-e-${i}`).textContent=''; }
          matchesE.textContent='Alice measured. Now decide whether Eve intercepts.'; keyE.textContent='Key : ';
        }

        function eveIntercept(){ for(let i=0;i<N;i++) if(!eveBases[i]){ alert('Pick Eve bases for all qubits (or leave none to skip).'); return; } for(let i=0;i<N;i++){ const c=eveBases[i]; if(c===trueBasesE[i]) eveBits[i]=trueBitsE[i]; else eveBits[i]=randBit(); // Eve collapses the qubit
            trueBasesE[i]=c; trueBitsE[i]=eveBits[i]; document.getElementById(`eve-bit-${i}`).textContent = eveBits[i]; document.getElementById(`bob-e-bit-${i}`).textContent='‚Äì'; document.getElementById(`match-e-${i}`).textContent=''; }
          matchesE.textContent='Eve has intercepted. Now choose Bob bases and measure.'; keyE.textContent='Key : ';
        }

        function bobMeasure(){ for(let i=0;i<N;i++) if(!bobBasesE[i]){ alert('Pick all Bob bases first'); return; } for(let i=0;i<N;i++){ const c=bobBasesE[i]; if(c===trueBasesE[i]) bobBitsE[i]=trueBitsE[i]; else bobBitsE[i]=randBit(); document.getElementById(`bob-e-bit-${i}`).textContent = bobBitsE[i]; const matchEl=document.getElementById(`match-e-${i}`);
            if(aliceBasesE[i] && bobBasesE[i]){ if(aliceBasesE[i]===bobBasesE[i]){ matchEl.textContent='MATCH'; matchEl.style.color='#9bf59b'; } else { matchEl.textContent='DIFF'; matchEl.style.color='#f59b9b'; } }
          }
          // derive key and show error rate
          const keyBits=[]; const matched=[]; let errors=0; let checks=0;
          for(let i=0;i<N;i++){
            // only keep bits where Alice and Bob used same basis
            if(aliceBasesE[i] && bobBasesE[i] && aliceBasesE[i]===bobBasesE[i]){
              checks++;
              matched.push(i+1);
              // If Eve intercepted using a different basis than Alice, Bob's qubit should be uncorrelated with Alice (random)
              // We already simulated Eve collapsing the qubit into trueBitsE when she intercepted. To make the effect explicit,
              // compare the stored Alice bit with Bob's measured bit and count errors.
              if(aliceBitsE[i] !== bobBitsE[i]) errors++; else keyBits.push(String(aliceBitsE[i]));
            }
          }
          matchesE.textContent = matched.length ? `Matched positions: ${matched.join(', ')} (errors: ${errors}/${checks})` : 'No matching bases ‚Äî no key bits kept.';
          keyE.textContent = keyBits.length ? `Key : ${keyBits.join('')}` : 'Key : (empty)';
        }

        gen.addEventListener('click', generate); aBtn.addEventListener('click', aliceMeasure); eBtn.addEventListener('click', eveIntercept); bBtn.addEventListener('click', bobMeasure); rBtn.addEventListener('click', generate);
        generate();
      })();
    </script>

    <!-- PARALLAX EFFECT SCRIPT -->
    <script>
      (function(){
        const body = document.body;
        if(!body) return;
        
        // Set initial background position to 0
        body.style.backgroundPositionY = '0px';
        
        let ticking = false;
        
        function updateParallax() {
          const scrolled = window.pageYOffset;
          const parallaxSpeed = -0.05;
          
          body.style.backgroundPositionY = `${scrolled * parallaxSpeed}px`;
          
          ticking = false;
        }
        
        function requestTick() {
          if (!ticking) {
            window.requestAnimationFrame(updateParallax);
            ticking = true;
          }
        }
        
        window.addEventListener('scroll', requestTick, { passive: true });
      })();
    </script>
    <!-- END PARALLAX EFFECT SCRIPT -->
    <!-- Audio element for background music -->
    <audio id="bgm" loop>
      <source src="media/bgm.mp3" type="audio/mpeg">
    </audio>
    <div id="settings-btn">‚öôÔ∏è</div>
    <div id="settings-menu">
      <div id="mute-option" class="option">Mute Music</div>
      <div id="theme-option" class="option">üîÑ Larger Fonts (Accessibility)</div>
    </div>
    <div id="info-container">
      <div id="info-icon">‚Ñπ</div>
      <div id="info-popup">This project is an informative and educational website designed to make information on quantum cryptography accessible to a wider audience.</div>
    </div>

  <!-- BACKGROUND MUSIC SYSTEM -->
  <script>
    (function(){
      const bgm = document.getElementById('bgm');
      if(!bgm) return;
      const btn = document.getElementById('settings-btn');
      const menu = document.getElementById('settings-menu');
      const muteOption = document.getElementById('mute-option');
      let menuOpen = false;

      let savedMuted = localStorage.getItem('musicMuted') === 'true';
      let savedTime = parseFloat(localStorage.getItem('musicTime')) || 0;
      bgm.muted = savedMuted;
      bgm.currentTime = savedTime;

      window.addEventListener('click', ()=>{ bgm.play().catch(()=>{}); bgm.volume = 0.2; }, { once: true });
      bgm.volume = 0.2; bgm.play().catch(()=>{});

      setInterval(()=>{ localStorage.setItem('musicTime', bgm.currentTime); }, 1000);

      btn.onclick = ()=>{ menuOpen = !menuOpen; menu.style.display = menuOpen ? 'block' : 'none'; };
      muteOption.onclick = ()=>{ bgm.muted = !bgm.muted; localStorage.setItem('musicMuted', bgm.muted); muteOption.textContent = bgm.muted ? 'Unmute Music' : 'Mute Music'; };
      muteOption.textContent = bgm.muted ? 'Unmute Music' : 'Mute Music';
    })();
  </script>
  <!-- END BACKGROUND MUSIC SYSTEM -->

  <!-- THEME SWITCHER SCRIPT -->
  <script>
    (function(){
      const themeOption = document.getElementById('theme-option');
      const themeSheet = document.getElementById('theme-stylesheet');
      if(!themeOption || !themeSheet) return;

      let useAccessibleTheme = localStorage.getItem('useAccessibleTheme') === 'true';
      
      function applyTheme(accessible) {
        if(accessible) {
          themeSheet.href = 'styl2.css';
          themeOption.textContent = 'üîÑ Standard Fonts';
          localStorage.setItem('useAccessibleTheme', 'true');
        } else {
          themeSheet.href = 'style.css';
          themeOption.textContent = 'üîÑ Larger Fonts (Accessibility)';
          localStorage.setItem('useAccessibleTheme', 'false');
        }
      }

      applyTheme(useAccessibleTheme);

      themeOption.addEventListener('click', ()=>{
        useAccessibleTheme = !useAccessibleTheme;
        applyTheme(useAccessibleTheme);
      });
    })();
  </script>
  <!-- END THEME SWITCHER SCRIPT -->

  <!-- LEVELS SIDEBAR TOGGLE SYSTEM -->
  <script>
    (function(){
      const tab = document.getElementById('levels-tab');
      const sidebar = document.getElementById('levels-sidebar');
      const closeBtn = document.getElementById('levels-close');
      if(tab && sidebar){
        tab.addEventListener('click', ()=>{ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); });
        closeBtn.addEventListener('click', ()=>{ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); });
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); } });
      }
    })();
  </script>
  <!-- END LEVELS SIDEBAR TOGGLE SYSTEM -->

  <!-- THEME SWITCHER SCRIPT -->
  <script>
    (function(){
      const themeOption = document.getElementById('theme-option');
      const themeSheet = document.getElementById('theme-stylesheet');
      if(!themeOption || !themeSheet) return;

      let useAccessibleTheme = localStorage.getItem('useAccessibleTheme') === 'true';
      
      function applyTheme(accessible) {
        if(accessible) {
          themeSheet.href = 'styl2.css';
          themeOption.textContent = 'üîÑ Standard Fonts';
          localStorage.setItem('useAccessibleTheme', 'true');
        } else {
          themeSheet.href = 'style.css';
          themeOption.textContent = 'üîÑ Larger Fonts (Accessibility)';
          localStorage.setItem('useAccessibleTheme', 'false');
        }
      }

      applyTheme(useAccessibleTheme);

      themeOption.addEventListener('click', ()=>{
        useAccessibleTheme = !useAccessibleTheme;
        applyTheme(useAccessibleTheme);
      });
    })();
  </script>
  <!-- END THEME SWITCHER SCRIPT -->
</body>
</html>
